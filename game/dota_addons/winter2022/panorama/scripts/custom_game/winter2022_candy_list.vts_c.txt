"use strict";
/// <reference path="../../../../../dota/panorama/scripts/dota.d.ts" />
/// <reference path="../../../../../dota/panorama/scripts/util.ts" />
/// <reference path="winter2022_shared.ts" />
const g_CandyState = SubscribeAllTableValues("candy_list", UpdateCandyList);
CustomNetTables.SubscribeNetTableListener("globals", UpdateCandyList);
let g_CandyPanels = {};
function Init() {
    $.GetContextPanel().RemoveAndDeleteChildren();
    g_CandyPanels = {};
    TrackAltPressed($.GetContextPanel());
    const nLocalTeam = Players.GetTeam(Players.GetLocalPlayer());
    $.GetContextPanel().SetHasClass("Spectating", nLocalTeam !== DOTATeam_t.DOTA_TEAM_BADGUYS && nLocalTeam !== DOTATeam_t.DOTA_TEAM_GOODGUYS);
    UpdateCandyList();
}
$.Schedule(1.0, Init);
function UpdateCandyList() {
    const nLocalTeam = Players.GetTeam(Players.GetLocalPlayer());
    const bLocalIsInGame = nLocalTeam === DOTATeam_t.DOTA_TEAM_BADGUYS || nLocalTeam === DOTATeam_t.DOTA_TEAM_GOODGUYS;
    const candyValues = {};
    Object.values(g_CandyState).forEach(state => {
        if (!state)
            return;
        const nPlayerID = Entities.GetPlayerOwnerID(state.entity_index);
        if (Players.IsValidPlayerID(nPlayerID))
            candyValues[nPlayerID] = (candyValues[nPlayerID] || 0) + state.candy_count;
    });
    GetValidPlayerIDs().forEach(nPlayerID => {
        const nCandyCount = candyValues[nPlayerID] || 0;
        const bShowCandy = nCandyCount !== 0 && (!bLocalIsInGame || nLocalTeam === Players.GetTeam(nPlayerID));
        if (bShowCandy) {
            const candyPanel = g_CandyPanels[nPlayerID] || CreatePlayerCandyPanel(nPlayerID);
            if (!candyPanel)
                return;
            candyPanel.SetDialogVariableInt("candy_count", nCandyCount);
            candyPanel.SetHasClass("Hidden", false);
        }
        else {
            const candyPanel = g_CandyPanels[nPlayerID];
            if (candyPanel) {
                candyPanel.SetDialogVariableInt("candy_count", 0);
                candyPanel.SetHasClass("Hidden", true);
            }
        }
    });
}
function CreatePlayerCandyPanel(nPlayerID) {
    if (g_CandyPanels[nPlayerID])
        return g_CandyPanels[nPlayerID];
    const bIsRadiant = Players.GetTeam(nPlayerID) == DOTATeam_t.DOTA_TEAM_GOODGUYS;
    const panelId = `${bIsRadiant ? "Radiant" : "Dire"}Player${nPlayerID}`;
    const hud = $.GetContextPanel().FindAncestor("HUDElements");
    if (!hud)
        return null;
    const playerPanel = hud.FindChildTraverse(panelId);
    if (!playerPanel)
        return null;
    const playerContainer = playerPanel.FindChildTraverse("SlantedContainerPanel");
    if (!playerContainer)
        return null;
    const playerRect = GetPanelRect(playerContainer);
    const candyPanel = $.CreatePanel("Panel", $.GetContextPanel(), `Player${nPlayerID}Candy`);
    candyPanel.BLoadLayoutSnippet("PlayerCandy");
    candyPanel.SwitchClass("team", bIsRadiant ? "PlayerCandyRadiant" : "PlayerCandyDire");
    candyPanel.SetPositionInPixels(playerRect.x, playerRect.height, 0);
    g_CandyPanels[nPlayerID] = candyPanel;
    return candyPanel;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ludGVyMjAyMl9jYW5keV9saXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2ludGVyMjAyMl9jYW5keV9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSx1RUFBdUU7QUFDdkUscUVBQXFFO0FBQ3JFLDZDQUE2QztBQUc3QyxNQUFNLFlBQVksR0FBRyx1QkFBdUIsQ0FBZ0IsWUFBWSxFQUFFLGVBQWUsQ0FBRSxDQUFDO0FBQzVGLGVBQWUsQ0FBQyx5QkFBeUIsQ0FBRSxTQUFTLEVBQUUsZUFBZSxDQUFFLENBQUM7QUFFeEUsSUFBSSxhQUFhLEdBQXdCLEVBQUUsQ0FBQztBQUM1QyxTQUFTLElBQUk7SUFFVCxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztJQUM5QyxhQUFhLEdBQUcsRUFBRSxDQUFBO0lBRWxCLGVBQWUsQ0FBRSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUUsQ0FBQztJQUV2QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFFLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBRSxDQUFDO0lBQy9ELENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxXQUFXLENBQUUsWUFBWSxFQUFFLFVBQVUsS0FBSyxVQUFVLENBQUMsaUJBQWlCLElBQUksVUFBVSxLQUFLLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBRSxDQUFDO0lBRTdJLGVBQWUsRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFDRCxDQUFDLENBQUMsUUFBUSxDQUFFLEdBQUcsRUFBRSxJQUFJLENBQUUsQ0FBQztBQUV4QixTQUFTLGVBQWU7SUFFcEIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBRSxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUUsQ0FBQztJQUMvRCxNQUFNLGNBQWMsR0FBRyxVQUFVLEtBQUssVUFBVSxDQUFDLGlCQUFpQixJQUFJLFVBQVUsS0FBSyxVQUFVLENBQUMsa0JBQWtCLENBQUM7SUFFbkgsTUFBTSxX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